# 智能行程规划Agent

这是一个基于Google ADK框架的智能行程规划助手，支持自然语言输入和多轮对话，能够根据用户的出发地、到达地、出发时间和用户偏好，提供个性化的旅行建议。

## 功能特点

- **自然语言理解**: 支持用户使用自然语言表达需求（如"我想去上海"、"明天出发"）
- **多轮对话**: 支持逐步收集信息，智能引导用户补充缺失信息
- **航班查询**: 根据出发地、到达地和出发时间查询可用航班
- **天气查询**: 获取目的地的天气信息，为出行提供参考
- **用户偏好分析**: 基于用户历史数据和偏好设置提供个性化建议
- **智能规划**: 大模型结合多源信息生成综合行程建议
- **日志记录**: 完整的操作日志，便于调试和监控

## 工具说明

### 1. 航班查询工具 (`search_flights`)
- **参数**: 
  - `departure_city`: 出发城市三字码 (如: PEK, SHA, CAN) - 模型会自动转换城市名称
  - `arrival_city`: 到达城市三字码
  - `departure_date`: 出发日期，标准格式 YYYY-MM-DD (如: 2024-12-20) - 模型需要处理相对日期转换
- **返回**: 包含航班号、时间、价格、航空公司等信息的航班列表（返回10条航班数据，由大模型筛选推荐）

### 2. 天气查询工具 (`get_weather_info`)
- **参数**:
  - `city`: 城市名称 (如: 北京, 上海, 广州)
  - `date`: 查询日期，支持多种格式 (如: 2024-12-20, 明天, 下周一)
- **返回**: 包含温度、天气状况、湿度、风力等天气信息

### 3. 用户偏好查询工具 (`get_user_preferences`)
- **参数**: 无（使用固定用户偏好）
- **返回**: 包含预算范围、航空公司偏好、出行风格、特殊需求等用户偏好信息
- **重要**: 航班推荐时会严格结合用户偏好进行筛选，包括航空公司偏好、预算范围、出行风格等

### 4. 当前时间查询工具 (`get_current_time`)
- **参数**: 无
- **返回**: 包含当前时间、日期、星期等时间信息，用于计算相对日期

## 使用方法

### 在代码中使用
```python
import asyncio
from agent import root_agent

async def plan_trip():
    # 支持自然语言输入
    user_query = "我想从北京去上海，明天出发"
    
    response = await root_agent.run(user_query)
    print(response)

# 运行
asyncio.run(plan_trip())
```

### 多轮对话示例
```python
import asyncio
from agent import root_agent

async def multi_turn_conversation():
    # 第一轮：用户只提供部分信息
    response1 = await root_agent.run("我想去上海")
    print("助手:", response1)
    
    # 第二轮：用户补充信息
    response2 = await root_agent.run("从北京出发，明天走")
    print("助手:", response2)

# 运行
asyncio.run(multi_turn_conversation())
```

## 对话模式

### 信息收集阶段
当用户信息不完整时，Agent会友好地询问缺失信息：
```
为了给您提供更好的行程建议，我还需要了解以下信息：
- 您从哪个城市出发？
- 计划什么时候出发？
- 您的用户ID是什么？（用于获取个性化偏好）
```

### 完整信息阶段
当信息完整时，Agent会按以下格式输出：

#### 行程规划思考过程
- 用户偏好分析（预算范围、航空公司偏好、出行风格、特殊需求等）
- 航班筛选过程（如何从10个航班中筛选出最适合的3个）
- 航空公司匹配度分析（哪些航班符合用户偏好）
- 价格合理性分析（是否符合预算范围）
- 时间便利性分析（是否适合出行风格）
- 综合因素考虑和评分

#### 推荐航班
以表格形式展示最多3个推荐航班，严格按照用户偏好筛选：

| 航班号 | 航空公司 | 出发时间 | 到达时间 | 时长 | 价格 | 推荐理由 |
|--------|----------|----------|----------|------|------|----------|
| [航班号] | [航空公司] | [出发时间] | [到达时间] | [时长] | [价格] | [详细推荐理由（包含航空公司偏好、价格合理性、时间便利性等）] |

**筛选标准**：
- **航空公司偏好匹配**（权重30%）：优先推荐用户偏好的航空公司
- **预算范围匹配**（权重25%）：严格控制价格在用户预算范围内
- **时间便利性**（权重25%）：根据出行风格选择合适时间段
- **机型舒适度**（权重10%）：考虑机型舒适性
- **其他因素**（权重10%）：综合考虑其他个性化需求

#### 行程规划建议
- 出行时间建议（结合用户出行风格）
- 住宿和交通建议（结合用户偏好）
- 其他个性化建议（座位偏好、餐饮偏好、特殊需求等）

## 支持的自然语言输入

### 城市名称
- 支持中文城市名：北京、上海、广州、深圳等
- 大模型自动理解城市名称

### 日期格式
- 标准格式：2024-12-20
- 相对日期：明天、后天、下周一、下周二等
- 自然表达：明天走、后天出发等

### 用户表达方式
- "我想去上海"
- "从北京出发"
- "明天走"
- "帮我规划一下从广州到成都的行程"
- "下周一出发"

## 日志记录

系统会记录以下操作的日志：
- 工具调用开始和完成
- 查询参数和结果摘要
- Agent处理过程
- 错误信息

日志格式：`时间 - 模块名 - 日志级别 - 消息内容`

## 扩展说明

当前版本使用模拟数据，在实际应用中可以：
1. 连接真实的航班API（如携程、去哪儿等）
2. 集成天气API（如和风天气、OpenWeatherMap等）
3. 连接用户数据库获取真实偏好信息
4. 添加更多工具（如酒店查询、景点推荐等）

## 依赖要求

- Python 3.8+
- google-adk
- litellm

## 测试样例

### 单轮对话测试

**测试用例1: 完整信息输入**
```
用户: "我想从北京去上海，明天出发"
```

**测试用例2: 自然语言表达**
```
用户: "帮我规划一下从广州到成都的行程，下周一出发"
```

**测试用例3: 混合表达**
```
用户: "明天从深圳飞杭州"
```

### 多轮对话测试

**测试用例4: 信息逐步完善**
```
第1轮: "我想去上海"
第2轮: "从北京出发"
第3轮: "明天走"
```

**测试用例5: 补充信息**
```
第1轮: "我想去杭州"
第2轮: "从深圳出发，后天出发"
```

**测试用例6: 复杂场景**
```
第1轮: "帮我规划行程"
第2轮: "从西安到重庆"
第3轮: "下周二出发"
```

### 边界情况测试

**测试用例7: 模糊表达**
```
用户: "我想去旅游"
```

**测试用例8: 不完整信息**
```
用户: "明天出发"
```

**测试用例9: 特殊日期**
```
用户: "我想从北京去上海，后天出发"
```

**测试用例10: 相对时间表达**
```
用户: "我想去上海，明天下午出发"
```

**测试用例11: 时间相关查询**
```
用户: "现在几点了？我想规划明天的行程"
```

### 预期输出格式

当信息完整时，Agent应输出：

```
<thinking>
[详细分析用户需求，考虑各种因素，包括：
- 用户偏好分析（预算范围1000-2000元、航空公司偏好中国国际航空和东方航空、商务出行风格等）
- 航班筛选过程（从10个航班中筛选出最适合的3个，严格按照用户偏好）
- 航空公司匹配度分析（优先选择中国国际航空和东方航空的航班）
- 价格合理性分析（控制在1000-2000元预算范围内）
- 时间便利性分析（商务出行适合上午或下午航班，避免深夜航班）
- 综合因素考虑和评分]
</thinking>

<recommended_flights>
{
    "flights": [
        {
            "flight_number": "MU5678",
            "airline": "东方航空",
            "departure_time": "2024-12-20 08:00",
            "arrival_time": "2024-12-20 10:30",
            "duration": "2小时30分钟",
            "price": "1200元",
            "recommendation_reason": "符合用户航空公司偏好（东方航空），价格在预算范围内（1000-2000元），时间适合商务出行（上午航班）"
        },
        {
            "flight_number": "CA1234",
            "airline": "中国国际航空",
            "departure_time": "2024-12-20 06:30",
            "arrival_time": "2024-12-20 09:00",
            "duration": "2小时30分钟",
            "price": "1350元",
            "recommendation_reason": "符合用户航空公司偏好（中国国际航空），价格合理，适合商务出行（早班机）"
        },
        {
            "flight_number": "CZ9012",
            "airline": "南方航空",
            "departure_time": "2024-12-20 09:30",
            "arrival_time": "2024-12-20 12:00",
            "duration": "2小时30分钟",
            "price": "980元",
            "recommendation_reason": "价格优惠，时间适中，作为备选方案"
        }
    ]
}
</recommended_flights>

<travel_suggestions>
[基于航班、天气、用户偏好的具体建议，包括：
- 出行时间建议（结合商务出行风格，建议选择上午航班）
- 天气相关建议（对出行的影响）
- 住宿和交通建议（结合用户偏好，推荐四星级以上酒店，地铁/出租车交通）
- 其他个性化建议（座位偏好靠窗，餐饮偏好素食，特殊需求无烟环境和WiFi）]
</travel_suggestions>
```

## 注意事项

1. 当前版本使用模拟数据，实际部署时需要连接真实的API
2. 支持自然语言输入，大模型自动理解城市名称和日期
3. 用户偏好已固定，无需用户ID
4. 航班信息以结构化JSON格式展示，最多推荐3个航班
5. 相对日期（如"明天"、"下周一"）由大模型调用get_current_time工具计算后转换为标准格式
6. **航班推荐严格结合用户偏好**：优先推荐用户偏好的航空公司，严格控制预算范围，根据出行风格选择合适时间 